SELECT A.name, A.cat, A.cost FROM (SELECT X.name, X.cid, X.cat, SUM(X.price) AS cost FROM (SELECT C.name, C.cid, P.title, B.cat, O.price FROM yrb_purchase AS P INNER JOIN yrb_customer AS C ON P.cid = C.cid INNER JOIN yrb_book AS B ON P.title = B.title AND P.year = B.year INNER JOIN yrb_offer AS O ON P.club = O.club AND P.title = O.title AND P.year = O.year) AS X GROUP BY X.name, X.cid, X.cat) AS A INNER JOIN (SELECT Y.name, Y.cid, MAX(Y.cost) AS max_cost FROM (SELECT X.name, X.cid, X.cat, SUM(X.price) AS cost FROM (SELECT C.name, C.cid, P.title, B.cat, O.price FROM yrb_purchase AS P INNER JOIN yrb_customer AS C ON P.cid = C.cid INNER JOIN yrb_book AS B ON P.title = B.title AND P.year = B.year INNER JOIN yrb_offer AS O ON P.club = O.club AND P.title = O.title AND P.year = O.year) AS X GROUP BY X.name, X.cid, X.cat) AS Y GROUP BY Y.name, Y.cid) AS B ON A.name = B.name AND A.cid = B.cid AND A.cost = B.max_cost