SELECT cid, CHAR(CAST(when AS DATE), USA) AS day, (Q.cost + S.cost) AS cost FROM (SELECT cid, when, SUM(cost) AS cost, SUM(weight) AS sum_weight FROM (SELECT cid, P.club, P.title, P.year, P.when, (qnty * price) AS cost, (qnty * weight) AS weight FROM yrb_purchase AS P INNER JOIN yrb_offer as O ON P.club = O.club AND P.title = O.title AND P.year = O.year INNER JOIN yrb_book AS B ON P.title = B.title AND P.year = B.year) GROUP BY cid, when ORDER BY cid) AS Q LEFT OUTER JOIN yrb_shipping AS S ON (sum_weight/500)*500 + 500 = S.weight